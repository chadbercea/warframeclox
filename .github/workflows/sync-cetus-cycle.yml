name: Sync Cetus Cycle Timestamp

on:
  schedule:
    # Run every 6 hours to keep timestamp fresh
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-timestamp:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Cetus cycle from Warframe API
        id: fetch
        run: |
          # Try multiple endpoints with browser-like headers
          ENDPOINTS=(
            "https://content.warframe.com/dynamic/worldState.php"
            "https://api.warframe.com/cdn/worldState.php"
          )

          for ENDPOINT in "${ENDPOINTS[@]}"; do
            echo "Trying: $ENDPOINT"
            RESPONSE=$(curl -sL --max-time 30 \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              -H "Accept: application/json, text/plain, */*" \
              -H "Accept-Language: en-US,en;q=0.9" \
              "$ENDPOINT" 2>/dev/null || echo "")

            # Check if we got valid JSON with SyndicateMissions
            if echo "$RESPONSE" | jq -e '.SyndicateMissions' > /dev/null 2>&1; then
              CETUS_DATA=$(echo "$RESPONSE" | jq -r '.SyndicateMissions[] | select(.Tag == "CetusSyndicate")')
              if [ -n "$CETUS_DATA" ]; then
                echo "Success with $ENDPOINT"
                break
              fi
            fi
            echo "Failed with $ENDPOINT, trying next..."
          done

          if [ -z "$CETUS_DATA" ]; then
            echo "All endpoints failed. Response preview:"
            echo "$RESPONSE" | head -c 500
            exit 1
          fi

          # Extract timestamps
          CYCLE_START=$(echo "$CETUS_DATA" | jq -r '.Activation."$date"."$numberLong"')
          CYCLE_END=$(echo "$CETUS_DATA" | jq -r '.Expiry."$date"."$numberLong"')

          echo "cycle_start=$CYCLE_START" >> $GITHUB_OUTPUT
          echo "cycle_end=$CYCLE_END" >> $GITHUB_OUTPUT
          echo "fetched_at=$(date +%s)000" >> $GITHUB_OUTPUT

          echo "Fetched Cetus cycle: start=$CYCLE_START, end=$CYCLE_END"

      - name: Update Vercel Edge Config
        env:
          VERCEL_ACCESS_TOKEN: ${{ secrets.VERCEL_ACCESS_TOKEN }}
          EDGE_CONFIG_ID: ${{ secrets.EDGE_CONFIG_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          # Update Edge Config with new timestamp
          curl -X PATCH "https://api.vercel.com/v1/edge-config/$EDGE_CONFIG_ID/items?teamId=$VERCEL_TEAM_ID" \
            -H "Authorization: Bearer $VERCEL_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "items": [
                {
                  "operation": "upsert",
                  "key": "cetus_cycle_start",
                  "value": ${{ steps.fetch.outputs.cycle_start }}
                },
                {
                  "operation": "upsert",
                  "key": "cetus_cycle_end",
                  "value": ${{ steps.fetch.outputs.cycle_end }}
                },
                {
                  "operation": "upsert",
                  "key": "cetus_synced_at",
                  "value": ${{ steps.fetch.outputs.fetched_at }}
                }
              ]
            }'

          echo "Updated Vercel Edge Config with new Cetus cycle data"
